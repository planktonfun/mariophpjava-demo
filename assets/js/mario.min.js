function drawRect(a,b,c,d,f){var e=document.getElementById("stats").getContext("2d");e.fillStyle="rgba("+f+",1)";e.fillRect(a,b,c,d)}function addTextTo(a,b,c){var d=document.getElementById("stats").getContext("2d");d.font="10px RockoUltraFLF";d.fillStyle="white";d.miterLimit=1;d.lineJoin="circle";d.lineWidth=3;d.strokeText(a,b,c);d.lineWidth=1;d.fillText(a,b,c)}function clearXCanvas(){var a=document.getElementById("stats");a.width=a.width}
function drawBlockByAction(a,b,c){var d=200/perimeter;addTextTo(c,d*a+5,d*b+11)}function drawBlockBySymbol(a,b,c){color=null;if(1==c)color="red";else if(7==c)color="green";else if(2==c||3==c)color="black";else if(4==c||5==c||6==c||8==c)color="white";null!=color&&drawBlock(a,b,color)}function drawBlock(a,b,c){var d=200/perimeter;c={black:"0,0,0",white:"255,255,255",red:"255,0,0",green:"0,255,0"}[c];drawRect(d*a,d*b,d,d,c)}
var start=function(a){recordings=[];playback?(recordings=loadRecordings(),setMap(1,1),initialTimestamp=getMicrotime(!0),playAll()):(setMap(1,1),initialTimestamp=getMicrotime(!0));lastfitness=totaliteration=currentright=currentscore=fitness=0;fpsstart=fps/1.82;var b=!1;$.each(a,function(a,d){3==d&&(b=!0)});if(!1==b)return $.post("/setTestCase.php",{cost:fitness,code:rawActions},function(a){console.log(a);location.href=location.href}),!1;a=compileGeneratedActions(a);startLoop(a)},compileGeneratedActions=
function(a){a=a.split("");for(var b={},c="",d=0,f=1;2>=f;f++)for(var e=1;e<=perimeter;e++)for(var k=1;k<=perimeter;k++)c=1==f?"white":"black",b[e+"-"+k+"-"+c]=a[d],d++;return b},getCenterMario=function(){for(var a={},b=1;b<=perimeter;b++)for(var c=1;c<=perimeter;c++)if(1==getSymbol(c,b)){a={x:c-1,y:b-1};break}return a},getColorBySymbol=function(a){var b=null;if(1==a)b=null;else if(7==a)b="white";else if(2==a||3==a)b="black";else if(4==a||5==a||6==a||8==a)b="white";return b},startLoop=function(a,b){clearXCanvas();
void 0==b&&(b=!1);for(var c={},d=[],f={},e=getCenterMario(),k=0,h=1;h<=perimeter;h++)for(var g=1;g<=perimeter;g++){var m=getSymbol(g-Math.floor(perimeter/2-e.x),h-Math.floor(perimeter/2-e.y));7==m&&(f[g-Math.floor(perimeter/2-e.x)]=1);void 0!==f[g-Math.floor(perimeter/2-e.x)]&&(m=7);8==h-Math.floor(perimeter/2-e.y)&&(m=5);var l=0,n=getColorBySymbol(m);void 0!=a[g+"-"+h+"-"+n]&&(l=a[g+"-"+h+"-"+n]);1==m&&(d=g+"-"+h);drawBlockBySymbol(g-1,h-1,m);drawBlockByAction(g-1,h-1,l);0!=l&&1!=l&&(2==l&&(k+=100),
c[l]=l)}var p=0;$.each(c,function(a){p++});0==p?execute(0):$.each(c,function(a){timeout=0;"2"==a&&(timeout=k);execute(a,timeout)});data.score.amount>currentscore?(fitness+=data.score.amount-currentscore,currentscore=data.score.amount,learningRate=0.12):learningRate=0.06;mario.right>currentright&&(fitness+=mario.right-currentright,currentright=mario.right);b||(totalFitness=fitness,localStorage.setItem("savedPerceptron",btoa(JSON.stringify(a))),localStorage.setItem("savedPerceptronFitness",fitness));
lastfitness==d?totaliteration++:totaliteration=0;lastfitness=d;c=!1;totaliteration>3*fpsstart&&(c=!0);mario.dying&&(c=!0);c&&limiters?$.post("/setTestCase.php",{cost:fitness,code:rawActions},function(a){location.href=location.href}):setTimeout(function(){startLoop(a,b)},1E3/fpsstart)},jumpenabled=!0,execute=function(a,b){if(!limiters)return!1;switch(a){case "1":keydown(65);break;case "2":jumpenabled&&(jumpenabled=!1,keydown(32),setTimeout(function(){keyup(32);jumpenabled=!0},b));break;case "3":fitness++;
keydown(68);break;case "4":keydown(83);break;case "5":keydown(16);break;case "6":keydown(65);jumpenabled&&(jumpenabled=!1,keydown(32),setTimeout(function(){keyup(32);jumpenabled=!0},b));break;case "7":keydown(65);fitness++;keydown(68);break;case "8":keydown(65);keydown(16);break;case "9":jumpenabled&&(jumpenabled=!1,keydown(32),setTimeout(function(){keyup(32);jumpenabled=!0},b));fitness++;keydown(68);break;case "A":jumpenabled&&(jumpenabled=!1,keydown(32),setTimeout(function(){keyup(32);jumpenabled=
!0},b));keydown(16);break;case "B":fitness++;keydown(68);keydown(16);break;default:keyup(65),keyup(32),keyup(68),keyup(83),keyup(16)}},getSymbol=function(a,b){if(inBetween(mario,a,b))return 1;var c=!1;$.each(characters,function(){inBetween(this,a,b)&&(c="enemy"==this.group?2:3)});if(c)return c;var d=!1;$.each(solids,function(){inBetween(this,a,b)&&(d="floor"==this.name?4:"Block unused"==this.name?5:"brick unused"==this.name?6:"pipe"==this.name?7:8)});return d?d:0},inBetween=function(a,b,c){var d=
(a.right-a.width)/canvas.width,f=a.top/canvas.height,e=(a.top-a.height)/canvas.height;a={x:{min:Math.round(a.right/canvas.width*perimeter),max:Math.round(d*perimeter)},y:{min:Math.round(f*perimeter),max:Math.round(e*perimeter)}};return a.x.min>=b&&a.x.max<=b&&a.y.min>=c&&a.y.max<=c?!0:!1};
