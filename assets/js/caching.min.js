var perimeter=13,perceptron=null,learningRate=0.12,actions=[1,2,3,4,5,0],fpsstart=5,fitness=0,currentscore=0,currentright=0,symbols=[0,1,2,3,4,5,6,7,8],percievedActions={},totalFitness=0,lastFitness=0,totaliteration=0,CACHE_NAME="cache-and-update",urlsToCache=[],Gene=function(a){0<a.length&&(this.code=a);this.cost=9999};Gene.prototype.code=[];Gene.prototype.random=function(){this.code=generateActions()};
Gene.prototype.mutate=function(a){if(!(Math.random()>a)){a=Math.floor(Math.random()*this.code.length)-1;var b=0.5>=Math.random()?-1:1,b=this.getShiftedLetters(a,b),c=[];for(i=0;i<this.code.length;i++)i==a&&(this.code[i]=b),c.push(this.code[i]);this.code=c}};Gene.prototype.getShiftedLetters=function(a,b){var c=a+b;0>c&&(c=actions.length-1);c>=actions.length&&(c=0);return actions[c]};
Gene.prototype.mate=function(a){var b=Math.round(this.code.length/2)-1,c=this.code.slice(0,b),d=this.code.slice(b),e=a.code.slice(0,b);a=a.code.slice(b);c=c.concat(a);d=e.concat(d);return[new Gene(c),new Gene(d)]};Gene.prototype.calculated=!1;Gene.prototype.calcCost=function(a){this.cost=a;this.calculated=!0};
var generateActions=function(){for(var a=[],b=symbols.length-1;0<=b;b--){var c=actions[Math.floor(Math.random()*actions.length)];a.push(c)}return a},compileGeneratedActions=function(a){var b={};$.each(function(a){b[a.x+"-"+a.y+"-"+a.symbol]=a.action});for(var c=symbols.length-1;0<=c;c--){var d=symbols[c],e=actions[Math.floor(Math.random()*actions.length)];0==symbols[c]&&(e=!1);for(var f=1;f<=perimeter;f++)for(var g=1;g<=perimeter;g++)!1!=e&&(b[g+"-"+f+"-"+d]=a[c])}return b},Population=function(a,
b){this.members=[];this.goal=a;for(this.generationNumber=0;b--;){var c=new Gene([]);c.random();this.members.push(c)}};Population.prototype.display=function(){console.log("<h2>Generation: "+this.generationNumber+"</h2>");console.log("<ul>");for(var a=0;a<this.members.length;a++)for(var b=0;b<this.members[a].code.length;b++)console.log("<li>"+this.members[a].code[b]+" ("+this.members[a].cost+")("+this.members[a].code.length+")");console.log("</ul>")};
Population.prototype.sort=function(){this.members.sort(function(a,b){return b.cost-a.cost})};Population.prototype.generation=function(){};self.addEventListener("install",function(a){a.waitUntil(precache())});function precache(){return caches.open(CACHE_NAME).then(function(a){return a.addAll(urlsToCache)})}
self.addEventListener("fetch",function(a){a.respondWith(caches.match(a.request).then(function(b){return b?b:fetch(a.request.clone()).then(function(a){return a})}));"POST"!=a.request.method&&!0!=/js\?/.test(a.request.url)&&a.waitUntil(update(a.request.clone()))});function update(a){return caches.open(CACHE_NAME).then(function(b){return fetch(a).then(function(c){return c&&200===c.status&&"basic"===c.type?b.put(a,c):c})})}
function sendMessage(a){return new Promise(function(b,c){navigator.serviceWorker.controller.postMessage(a);window.serviceWorker.onMessage=function(a){b(a.data)}})}var population=new Population(perimeter*perimeter,20),halfgeneration=!1;
self.addEventListener("message",function(a){if("startPopulation"==a.data){console.log("start");console.log("generation "+population.generationNumber);for(var b=0;b<population.members.length;b++)if(!1==population.members[b].calculated){console.log("sending member: "+b);a.source.postMessage(["geneSent",b,population.members[b].code]);return}population.sort();b=population.members[0].mate(population.members[1]);population.members.splice(population.members.length-2,2,b[0],b[1]);b=population.members[2].mate(population.members[3]);
population.members.splice(population.members.length-4,2,b[0],b[1]);b=population.members[4].mate(population.members[5]);population.members.splice(population.members.length-6,2,b[0],b[1]);for(b=0;b<population.members.length;b++)population.members[b].mutate(0.5),population.members[b].calculated=!1;halfgeneration=!0;population.generationNumber++;console.log("half gen");console.log("sending another member: 0");a.source.postMessage(["geneSent",0,population.members[0].code])}else"getPercievedAction"==a.data?
a.source.postMessage(actions):"done"==a.data[0]?(console.log(a.data),population.members[a.data[2]].calcCost(a.data[1]),a.source.postMessage(["startAgain"])):a.source.postMessage("Hello! Your message was: "+a.data)});
