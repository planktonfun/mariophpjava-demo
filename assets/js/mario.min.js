function drawRect(a,c,b,d,f){var e=document.getElementById("stats").getContext("2d");e.fillStyle="rgba("+f+",1)";e.fillRect(a,c,b,d)}function addTextTo(a,c,b){var d=document.getElementById("stats").getContext("2d");d.font="10px RockoUltraFLF";d.fillStyle="white";d.miterLimit=1;d.lineJoin="circle";d.lineWidth=3;d.strokeText(a,c,b);d.lineWidth=1;d.fillText(a,c,b)}function clearXCanvas(){var a=document.getElementById("stats");a.width=a.width}
function drawBlockByAction(a,c,b){var d=200/perimeter;addTextTo(b,d*a+5,d*c+11)}function drawBlockBySymbol(a,c,b){color=null;if(1==b)color="red";else if(7==b)color="green";else if(2==b||3==b)color="black";else if(4==b||5==b||6==b||8==b)color="white";null!=color&&drawBlock(a,c,color)}function drawBlock(a,c,b){var d=200/perimeter;b={black:"0,0,0",white:"255,255,255",red:"255,0,0",green:"0,255,0"}[b];drawRect(d*a,d*c,d,d,b)}
var start=function(a){recordings=[];playback?(recordings=loadRecordings(),setMap(8,4),initialTimestamp=getMicrotime(!0),playAll()):(setMap(8,4),initialTimestamp=getMicrotime(!0));lastfitness=totaliteration=currentright=currentscore=fitness=0;fpsstart=fps/1.82;var c=!1;$.each(a,function(a,b){3==b&&(c=!0)});if(!1==c)return $.post("/setTestCase.php",{cost:fitness,code:rawActions},function(a){console.log(a);location.href=location.href}),!1;var b=compileGeneratedActions(a);setTimeout(function(){startLoop(b)},
1E3)},compileGeneratedActions=function(a){a=a.split("");for(var c={},b="",d=0,f=1;2>=f;f++)for(var e=1;e<=perimeter;e++)for(var k=1;k<=perimeter;k++)b=1==f?"white":"black",c[e+"-"+k+"-"+b]=a[d],d++;return c},getCenterMario=function(){for(var a={},c=1;c<=perimeter;c++)for(var b=1;b<=perimeter;b++)if(1==getSymbol(b,c)){a={x:b-1,y:c-1};break}return a},getColorBySymbol=function(a){var c=null;if(1==a)c=null;else if(7==a)c="white";else if(2==a||3==a)c="black";else if(4==a||5==a||6==a||8==a)c="white";return c},
startLoop=function(a,c){clearXCanvas();void 0==c&&(c=!1);var b={},d=[],f={},e=getCenterMario(),k=0;void 0==e.x&&(e={x:0,y:0});for(var h=1;h<=perimeter;h++)for(var g=1;g<=perimeter;g++){var m=getSymbol(g-Math.floor(perimeter/2-e.x),h-Math.floor(perimeter/2-e.y));7==m&&(f[g-Math.floor(perimeter/2-e.x)]=1);void 0!==f[g-Math.floor(perimeter/2-e.x)]&&(m=7);8==h-Math.floor(perimeter/2-e.y)&&(m=5);var l=0,n=getColorBySymbol(m);void 0!=a[g+"-"+h+"-"+n]&&(l=a[g+"-"+h+"-"+n]);1==m&&(d=g+"-"+h);drawBlockBySymbol(g-
1,h-1,m);drawBlockByAction(g-1,h-1,l);0!=l&&1!=l&&(2==l&&(k+=100),b[l]=l)}var p=0;$.each(b,function(a){p++});0==p?execute(0):$.each(b,function(a){timeout=0;"2"==a&&(timeout=k);execute(a,timeout)});data.score.amount>currentscore?(fitness+=data.score.amount-currentscore,currentscore=data.score.amount,learningRate=0.12):learningRate=0.06;mario.right>currentright&&(fitness+=mario.right-currentright,currentright=mario.right);c||(totalFitness=fitness,localStorage.setItem("savedPerceptron",btoa(JSON.stringify(a))),
localStorage.setItem("savedPerceptronFitness",fitness));lastfitness==d?totaliteration++:totaliteration=0;lastfitness=d;b=!1;totaliteration>3*fpsstart&&(b=!0);mario.dying&&(b=!0);b&&limiters?$.post("/setTestCase.php",{cost:fitness,code:rawActions},function(a){location.href=location.href}):setTimeout(function(){startLoop(a,c)},1E3/fpsstart)},jumpenabled=!0,execute=function(a,c){if(!limiters)return!1;switch(a){case "1":keydown(65);break;case "2":jumpenabled&&(jumpenabled=!1,keydown(32),setTimeout(function(){keyup(32);
jumpenabled=!0},c));break;case "3":fitness++;keydown(68);break;case "4":keydown(83);break;case "5":keydown(16);break;case "6":keydown(65);jumpenabled&&(jumpenabled=!1,keydown(32),setTimeout(function(){keyup(32);jumpenabled=!0},c));break;case "7":keydown(65);fitness++;keydown(68);break;case "8":keydown(65);keydown(16);break;case "9":jumpenabled&&(jumpenabled=!1,keydown(32),setTimeout(function(){keyup(32);jumpenabled=!0},c));fitness++;keydown(68);break;case "A":jumpenabled&&(jumpenabled=!1,keydown(32),
setTimeout(function(){keyup(32);jumpenabled=!0},c));keydown(16);break;case "B":fitness++;keydown(68);keydown(16);break;default:keyup(65),keyup(32),keyup(68),keyup(83),keyup(16)}},getSymbol=function(a,c){if(inBetween(mario,a,c))return 1;var b=!1;$.each(characters,function(){inBetween(this,a,c)&&(b="enemy"==this.group?2:3)});if(b)return b;var d=!1;$.each(solids,function(){inBetween(this,a,c)&&(d="floor"==this.name?4:"Block unused"==this.name?5:"brick unused"==this.name?6:"pipe"==this.name?7:8)});return d?
d:0},inBetween=function(a,c,b){var d=(a.right-a.width)/canvas.width,f=a.top/canvas.height,e=(a.top-a.height)/canvas.height;a={x:{min:Math.round(a.right/canvas.width*perimeter),max:Math.round(d*perimeter)},y:{min:Math.round(f*perimeter),max:Math.round(e*perimeter)}};return a.x.min>=c&&a.x.max<=c&&a.y.min>=b&&a.y.max<=b?!0:!1};
